const fs = require('fs');
const path = require('path');

const ASSET_PACKAGE_DIR = path.join(__dirname, '../Asset-Package/Architecture-Service-Icons_07312025');
const OUTPUT_FILE = path.join(__dirname, '../packages/fossflow-app/src/generatedAwsIcons.ts');

function getAllFiles(dirPath, arrayOfFiles) {
  const files = fs.readdirSync(dirPath);

  arrayOfFiles = arrayOfFiles || [];

  files.forEach(function(file) {
    if (fs.statSync(dirPath + '/' + file).isDirectory()) {
      arrayOfFiles = getAllFiles(dirPath + '/' + file, arrayOfFiles);
    } else {
      arrayOfFiles.push(path.join(dirPath, '/', file));
    }
  });

  return arrayOfFiles;
}

function generateIcons() {
  console.log(`Scanning ${ASSET_PACKAGE_DIR}...`);
  
  if (!fs.existsSync(ASSET_PACKAGE_DIR)) {
    console.error(`Directory not found: ${ASSET_PACKAGE_DIR}`);
    process.exit(1);
  }

  const allFiles = getAllFiles(ASSET_PACKAGE_DIR);
  
  // Filter for SVGs in "48" folders
  const iconFiles = allFiles.filter(file => {
    return file.endsWith('.svg') && (file.includes(path.sep + '48' + path.sep) || file.includes('/48/'));
  });

  console.log(`Found ${iconFiles.length} icons.`);

  const icons = iconFiles.map(filePath => {
    const filename = path.basename(filePath, '.svg');
    // Example filename: Arch_AWS-Lambda_48.svg
    // Title: AWS Lambda
    
    // Remove "Arch_" prefix if present
    let title = filename.replace(/^Arch_/, '');
    // Remove "_48" suffix if present
    title = title.replace(/_48$/, '');
    // Replace hyphens/underscores with spaces
    title = title.replace(/[-_]/g, ' ');
    
    // Category from parent folder (grandparent of file usually, since parent is "48")
    // .../CategoryName/48/icon.svg
    const parts = filePath.split(path.sep);
    const parentDir = parts[parts.length - 2]; // "48"
    let category = 'AWS'; // Default
    
    if (parentDir === '48') {
      let catDir = parts[parts.length - 3];
      // Clean up category name (e.g. "Arch_Compute" -> "Compute")
      catDir = catDir.replace(/^Arch_/, '');
      category = catDir;
    }

    const svgContent = fs.readFileSync(filePath, 'utf8');

    return {
      id: filename,
      name: title,
      title: title,
      category: category,
      collection: 'aws',
      url: '', // Not used if svg content is provided
      svg: svgContent
    };
  });

  const outputContent = `// Auto-generated by scripts/generate-aws-icons.js
export const generatedAwsIcons = {
  name: 'aws',
  title: 'AWS Official Icons',
  icons: ${JSON.stringify(icons, null, 2)}
};

export default generatedAwsIcons;
`;

  fs.writeFileSync(OUTPUT_FILE, outputContent);
  console.log(`Generated ${OUTPUT_FILE} with ${icons.length} icons.`);
}

generateIcons();
